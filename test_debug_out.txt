============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-9.0.2, pluggy-1.6.0 -- /mnt/d/dev2/project-stock2/venv/bin/python3
cachedir: .pytest_cache
rootdir: /mnt/d/dev2/project-stock2
configfile: pytest.ini
plugins: anyio-4.12.0, cov-7.0.0
collecting ... collected 9 items

tests/test_commands.py::TestExtractCommand::test_execute_no_candidates PASSED
tests/test_commands.py::TestExtractCommand::test_execute_with_candidates FAILED
tests/test_commands.py::TestAnalyzeCommand::test_execute_no_candidates PASSED
tests/test_commands.py::TestAnalyzeCommand::test_execute_processes_candidates FAILED
tests/test_commands.py::TestIngestCommand::test_execute_ingest_valid_json PASSED
tests/test_commands.py::TestIngestCommand::test_execute_no_files PASSED
tests/test_commands.py::TestIngestCommand::test_export_to_csv_chunking PASSED
tests/test_commands.py::TestIngestCommand::test_export_to_csv_no_results PASSED
tests/test_commands.py::TestIngestCommand::test_export_to_csv_with_data PASSED

=================================== FAILURES ===================================
_______________ TestExtractCommand.test_execute_with_candidates ________________

self = <test_commands.TestExtractCommand testMethod=test_execute_with_candidates>
mock_validator_cls = <MagicMock name='ValidationEngine' id='137999359911328'>
mock_agent_cls = <MagicMock name='AIAgent' id='137999352594208'>
mock_db_cls = <MagicMock name='StockDatabase' id='137999352597968'>
mock_provider_cls = <MagicMock name='DataProvider' id='137999352601760'>
mock_engine_cls = <MagicMock name='AnalysisEngine' id='137999352605552'>

    @patch("src.engine.AnalysisEngine")
    @patch("src.provider.DataProvider")
    @patch("src.database.StockDatabase")
    @patch("src.commands.extract.AIAgent")
    @patch("src.commands.extract.ValidationEngine")
    def test_execute_with_candidates(
        self,
        mock_validator_cls,
        mock_agent_cls,
        mock_db_cls,
        mock_provider_cls,
        mock_engine_cls,
    ):
        """execute should process candidates and save valid tasks."""
        from src.commands.extract import ExtractCommand
    
        # Setup mocks
        df = pd.DataFrame(
            [
                {
                    "code": "1001",
                    "name": "Test",
                    "quant_score": 80,
                    "sector": "Tech",
                    "market_data_id": 1,
                    # Tier 1 Required
                    "current_price": 1000,
                    "operating_cf": 500,
                    "operating_margin": 10,
                    "per": 15,
                    "pbr": 1.2,
                    "roe": 10,
                }
            ]
        )
        mock_provider = MagicMock()
        mock_provider.load_latest_market_data.return_value = df
        mock_provider.stock_db = MagicMock()
        mock_provider_cls.return_value = mock_provider
    
        mock_db = MagicMock()
        mock_db.get_ai_cache.return_value = None
        mock_db.get_market_data_id.return_value = 1
        mock_db_cls.return_value = mock_db
    
        mock_agent = MagicMock()
        mock_agent._create_prompt.return_value = "Test Prompt"
        mock_agent_cls.return_value = mock_agent
    
        mock_validator = MagicMock()
        mock_validator.validate.return_value = (True, None)  # Valid
        mock_validator_cls.return_value = mock_validator
    
        mock_engine = MagicMock()
        mock_engine.calculate_scores.return_value = df
        mock_engine.filter_and_rank.return_value = df
        mock_engine_cls.return_value = mock_engine
    
        with tempfile.TemporaryDirectory() as tmpdir:
            cmd = ExtractCommand(get_mock_config(), debug_mode=True)
            cmd.interim_dir = tmpdir
            output_path = os.path.join(tmpdir, "test_output.json")
    
            cmd.execute(strategy="test_strategy", limit=5, output_path=output_path)
    
            # Verify output file exists
>           self.assertTrue(os.path.exists(output_path))
E           AssertionError: False is not true

tests/test_commands.py:142: AssertionError
_____________ TestAnalyzeCommand.test_execute_processes_candidates _____________

self = <test_commands.TestAnalyzeCommand testMethod=test_execute_processes_candidates>
mock_writer_cls = <MagicMock name='ResultWriter' id='137999369375376'>
mock_agent_cls = <MagicMock name='AIAgent' id='137999351097264'>
mock_db_cls = <MagicMock name='StockDatabase' id='137999351101344'>
mock_provider_cls = <MagicMock name='DataProvider' id='137999351252656'>
mock_engine_cls = <MagicMock name='AnalysisEngine' id='137999351256448'>

    @patch("src.engine.AnalysisEngine")
    @patch("src.provider.DataProvider")
    @patch("src.database.StockDatabase")
    @patch("src.commands.analyze.AIAgent")
    @patch("src.commands.analyze.ResultWriter")
    def test_execute_processes_candidates(
        self,
        mock_writer_cls,
        mock_agent_cls,
        mock_db_cls,
        mock_provider_cls,
        mock_engine_cls,
    ):
        """execute should process candidates with AI agent and save results."""
        from src.commands.analyze import AnalyzeCommand
    
        # Mocks
        df = pd.DataFrame(
            [
                {
                    "code": "2001",
                    "name": "AnalyzeTest",
                    "quant_score": 75,
                    "sector": "Retail",
                    "market_data_id": 2,
                    # Tier 1 Required
                    "current_price": 2000,
                    "operating_cf": 1000,
                    "operating_margin": 15,
                    "per": 12,
                    "pbr": 1.5,
                    "roe": 12,
                    "ocf_margin": 10,
                    "equity_ratio": 50,  # [v2.0] used in is_abnormal
                }
            ]
        )
    
        mock_provider = MagicMock()
        mock_provider.load_latest_market_data.return_value = df
        mock_provider.get_ai_cache.return_value = (None, "hash123")  # No cache
        mock_provider.stock_db = MagicMock()
        mock_provider_cls.return_value = mock_provider
    
        mock_db = MagicMock()
        mock_db_cls.return_value = mock_db
    
        mock_agent = MagicMock()
        mock_agent.analyze.return_value = {
            "ai_sentiment": "Bullish",
            "ai_reason": "Good",
        }
        mock_agent.get_total_calls.return_value = 0
        mock_agent_cls.return_value = mock_agent
    
        mock_writer = MagicMock()
        mock_writer_cls.return_value = mock_writer
    
        mock_engine = MagicMock()
        mock_engine.calculate_scores.return_value = df
        mock_engine.filter_and_rank.return_value = df
        mock_engine_cls.return_value = mock_engine
    
        cmd = AnalyzeCommand(get_mock_config(), debug_mode=True)
        cmd.execute(strategy="test_strategy", limit=1)
    
        # Verify AI analyze was called
>       mock_agent.analyze.assert_called_once()

tests/test_commands.py:242: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <MagicMock name='AIAgent().analyze' id='137999351054112'>

    def assert_called_once(self):
        """assert that the mock was called only once.
        """
        if not self.call_count == 1:
            msg = ("Expected '%s' to have been called once. Called %s times.%s"
                   % (self._mock_name or 'mock',
                      self.call_count,
                      self._calls_repr()))
>           raise AssertionError(msg)
E           AssertionError: Expected 'analyze' to have been called once. Called 0 times.

/usr/lib/python3.12/unittest/mock.py:923: AssertionError
=========================== short test summary info ============================
FAILED tests/test_commands.py::TestExtractCommand::test_execute_with_candidates
FAILED tests/test_commands.py::TestAnalyzeCommand::test_execute_processes_candidates
========================= 2 failed, 7 passed in 16.01s =========================
