# 障害レポート (2025-12-31)

### 検出された不具合一覧

| 検出時刻 | 通番 | 不具合の概要                                         | 原因の提示                                                                                                                                 | 影響 (Impact)                                                | 修正案 (Proposed Fix)                                                                                                             | ステータス     |
| :------- | :--- | :--------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------- | :----------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------- | :------------- |
| 18:20    | No.1 | `test_collector_integration.py` のテスト失敗         | `collector.py` を `archive/` へ移動したため、インポートが壊れた。                                                                          | テストスイート全体が正常に完了しない。                       | 当該テストファイルを `tests/archive/` へ移動し、アクティブなテストから除外する。                                                  | 修正済 (Fixed) |
| 18:58    | No.2 | `self_diagnostic.py` の実行エラー (TypeError)        | `Calculator.calc_quant_score` が `ScoringEngine` への委譲に際し `strategy_name` 引数を期待するようになったが、テスト側で渡していなかった。 | 自己診断ツールが動作不能になる。                             | `Calculator` クラスに `calc_quant_score` のオーバーライドを追加し、引数なしでもデフォルト戦略で動作するよう後方互換性を確保する。 | 修正済 (Fixed) |
| 19:00    | No.3 | `self_diagnostic.py` のスコア不一致 (AssertionError) | V2の重み付け計算（ファンダメンタル70%:トレンド30%）がデフォルトになったため、従来のV1基準の期待値（20点など）と乖離した。                  | スコア計算の妥当性検証が正しく行われない。                   | 期待値を新しいV2の計算式（加点 * 0.7 + ベース * 0.3）に基づく値に更新する。                                                       | 修正済 (Fixed) |
| 19:30    | No.4 | 分析結果エクスポート失敗 (sqlite3.OperationalError)  | フェーズ3で導入した新カラム (`ma_divergence`, `volume_ratio`) のマイグレーションコードが `src/database.py` に不足していた。                | 投資レポートの出力が完全に停止する。                         | `src/database.py` の `_manual_migration` に当該カラムを追加し、スキーマの自動更新を有効にする。                                   | 修正済 (Fixed) |
| 20:10    | No.5 | AI分析エラー (AttributeError)                        | `AIAgent` のバリデーションロジック集約時に、`analyze` 内の古いメソッド呼び出し (`_validate_strict`) を消し忘れていた。                     | 全銘柄のAI分析においてエラーが発生し、処理が中断・失敗する。 | `src/ai_agent.py` の `analyze` メソッド内の不要なメソッド呼び出しを削除し、`_validate_response` へ一本化する。                    | 修正済 (Fixed) |
