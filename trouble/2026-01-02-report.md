# 不具合報告書 (2026-01-02)

| 検出時刻 | 通番 | 不具合の概要                                                                          | 原因の提示                                                                                      | 影響 (Impact)                                              | 修正案 (Proposed Fix)                                                              |
| :------- | :--- | :------------------------------------------------------------------------------------ | :---------------------------------------------------------------------------------------------- | :--------------------------------------------------------- | :--------------------------------------------------------------------------------- |
| 14:20    | No.1 | AIAgent で `AttributeError: 'AIAgent' object has no attribute 'strategy_name'` が発生 | `analyze` メソッド内でクラス属性 `self.strategy_name` を参照したが、実際には存在しなかった      | AI分析プロセスが途中で停止し、一切の分析が実行されない     | メソッド引数 `strategy_name` を参照するように修正（実施済み）                      |
| 14:28    | No.2 | 市場スキャンで 0 銘柄が選定される (Integrity Alert)                                   | DBの `price` と Pydantic の `current_price` の名称不一致により必須データ欠損と判定された        | 全銘柄がバリデーションで足切りされ、分析対象から除外される | `StockAnalysisData` に `price` へのエイリアスマッピングを追加（実施済み）          |
| 14:28    | No.3 | ターンアラウンド戦略などで Tier 1 項目欠損により足切りされる                          | `ValidationEngine.validate_stock_data` で戦略固有の `na_allowed` ポリシーが考慮されていなかった | 財務困難銘柄（ターンアラウンド）が分析対象から漏れる       | `validate_stock_data` に `strategy` 引数を追加し、動的にポリシーを適用（実施済み） |

## テストで検出されなかった理由
1. **モックの過剰使用**: `self_diagnostic.py` において `AIAgent` を丸ごとモック化していたため、内部の属性参照エラーを検知できなかった。
2. **モデル間の疎結合**: DBモデル (`MarketData`) とドメインモデル (`StockAnalysisData`) を直接連携させたテストが不足しており、物理的なカラム名の乖離を検出できなかった。
3. **戦略別テストの不足**: バリデーションテストが「デフォルト」または「特定の文字列」に依存しており、戦略別のポリシー切り替えをトリガーしていなかった。
