# 障害レポート: 2025-12-25

## 不具合一覧

### No.1 - `_save_quarantine` メソッドで `error_path` が未定義 ✅ 修正済
### No.2 - `extract` モードが `run()` メソッドから正しく呼び出されない ✅ 修正済
### No.3 - `turnaround_spec` 戦略でROE欠損がQuarantine対象になる ✅ 修正済

---

### No.4 - プロンプトテンプレートの競合状態（Race Condition）
**検出時刻:** 14:45  
**概要:** ThreadPoolExecutorで複数のワーカーが並列実行される際、`_load_prompt_template()` が複数スレッドから同時に呼び出され、最初の1スレッドのみが正常にテンプレートをロードし、他のスレッドは空の `{}` を読んで `"Error: Prompt template missing."` を返す。  
**原因の推定:** `_create_prompt` 内で遅延ロードされる設計だが、マルチスレッド環境でのロック機構がない。複数スレッドが同時に `self.prompt_config = {}` を設定し、ファイルロードが完了する前に他のスレッドがこの空値を読む。

**証拠（再現テスト結果）:**
```
1: Error: Prompt template missing.
2: Error: Prompt template missing.
3: Error: Prompt template missing.
4: Error: Prompt template missing.
0: You are a **Analysis Expert**. Analyze the followi  ← 最初の1件のみ成功
```

**影響:**
- extractモードで複数候補を並列処理する際、ほとんどのタスクがエラーのプロンプトを持つ
- AIによる分析が正しく行われない

**修正案:**
`AntigravityRunner.__init__` で `agent._load_prompt_template()` を明示的に呼び出し、事前にテンプレートをロードしておく。

```python
# antigravity_runner.py __init__ 内
self.agent = AIAgent(model_name="gemini-2.0-flash-exp", debug_mode=debug_mode)
self.agent.sector_policies = self.config.get('sector_policies', {})
self.agent.set_config(self.config)
# [v7.4] 事前にプロンプトテンプレートをロード（Race Condition対策）
self.agent._load_prompt_template()
```

---  
**概要:** `antigravity_runner.py` 208-215行目の `_save_quarantine` メソッドが未定義変数 `error_path` を参照しており、すべてのQuarantine処理（エラータスク保存）が実行時例外でサイレント失敗する。  
**原因の推定:** 変数 `error_path` が定義される前に `open(error_path, ...)` が呼ばれている。本来、quarantineディレクトリへのパスを生成するコードが欠落している。  
**影響:**
- extract/analyzeモードで検証失敗したタスクがQuarantineフォルダに保存されない
- **後続の処理もサイレントに終了する可能性がある（例外発生箇所が致命的）**

**証拠コード (`antigravity_runner.py:208-215`):**
```python
def _save_quarantine(self, error_tasks, strategy):
    """Save error tasks to quarantine directory."""
    if not error_tasks:
        return

    with open(error_path, 'w', encoding='utf-8') as f:  # ← error_path が未定義！
        json.dump(error_tasks, f, indent=2, ensure_ascii=False)
    print(f"🚫 Quarantined {len(error_tasks)} tasks to: {error_path}")
```

**修正案:**
```python
def _save_quarantine(self, error_tasks, strategy):
    """Save error tasks to quarantine directory."""
    if not error_tasks:
        return

    quarantine_dir = os.path.join(self.interim_dir, "quarantine")
    os.makedirs(quarantine_dir, exist_ok=True)
    ts = datetime.now().strftime('%Y%m%d_%H%M%S')
    error_path = os.path.join(quarantine_dir, f"quarantine_{strategy}_{ts}.json")
    
    with open(error_path, 'w', encoding='utf-8') as f:
        json.dump(error_tasks, f, indent=2, ensure_ascii=False, default=str)
    print(f"🚫 Quarantined {len(error_tasks)} tasks to: {error_path}")
```

---

### No.2 - `extract` モードが `run()` メソッドから正しく呼び出されない
**検出時刻:** 14:38  
**概要:** CLIから `--mode extract` を実行すると、`extract()` メソッドではなく `_collect_and_validate()` が直接呼ばれている。このため、**有効なタスクがあってもJSONファイルが保存されずにプロセスが終了する**。  
**原因の推定:** CLIのdispatch部分（724-728行目）で `extract` モードが `_collect_and_validate` を呼んでいるが、その結果（`valid_tasks`）を受け取ってファイル保存する処理がない。本来は `self.extract(...)` を呼ぶべき。

**証拠コード (`antigravity_runner.py:724-728`):**
```python
if args.mode == "extract":
     if not args.strategy:
         print("❌ --strategy is required for extract mode.")
         return
     self._collect_and_validate(args.strategy, args.limit, debug_mode=args.debug)
     # ← 戻り値を無視！ファイル保存されない！
```

**修正案:**
```python
if args.mode == "extract":
     if not args.strategy:
         print("❌ --strategy is required for extract mode.")
         return
     self.extract(args.strategy, args.limit, output_path=args.output)
```

---

### No.3 - `turnaround_spec` 戦略でROE欠損がQuarantine対象になる
**検出時刻:** 14:40  
**概要:** 現在の設定では `_strategy_turnaround_spec` で `per` は `na_allowed` に含まれているが、`roe` および `operating_margin` は含まれていない。ユーザーの報告によると、`turnaround_spec` の候補が「ROE欠損」でQuarantineされていた。  
**原因の推定:** distressed asset（財務困難銘柄）を対象とする戦略では、ROEやOperating Marginが欠損していることが多い。しかし現在の `_strategy_turnaround_spec` ポリシーには `roe` や `operating_margin` が `na_allowed` に入っていない。
**影響:**
- ターンアラウンド戦略では財務困難銘柄が多く、ROE等が計算不能な場合がある
- これらがすべてQuarantineされ、有効なタスクが0件になる

**証拠 (`config/config.yaml:373-376`):**
```yaml
_strategy_turnaround_spec:
  na_allowed: [per]  # ← per のみ。roe, operating_margin が入っていない
  score_exemptions: [per]
  ai_prompt_excludes: [PER]
```

**修正案:**
```yaml
_strategy_turnaround_spec:
  na_allowed: [per, roe, operating_margin, debt_equity_ratio, free_cf, operating_cf, pbr]
  score_exemptions: [per]
  ai_prompt_excludes: [PER]
```

---

## 複合問題の因果関係

```
User runs: --mode extract --strategy turnaround_spec
    ↓
1. _collect_and_validate() でバリデーション実行
    ↓
2. turnaround_spec 戦略は ROE が na_allowed に入っていない
    ↓
3. ROE欠損銘柄が全件 Quarantine → valid_tasks = 0件
    ↓
4. (仮に valid_tasks > 0 でも) run() が _collect_and_validate() を直接呼び、
   戻り値を無視しているのでファイル保存されない
    ↓
5. (仮に error_tasks を保存しようとしても) _save_quarantine() で
   error_path 未定義の NameError が発生し、サイレント終了の可能性
```

## 調査結果まとめ

| No  | 優先度       | 種別       | 概要                                          |
| --- | ------------ | ---------- | --------------------------------------------- |
| 1   | **Critical** | コードバグ | `_save_quarantine` の `error_path` 未定義     |
| 2   | **Critical** | コードバグ | `extract` モードがファイル保存をスキップ      |
| 3   | Medium       | 設定不備   | `turnaround_spec` で ROE 等の na_allowed 不足 |

## 次のアクション

ユーザーの指示を待って修正を行う。
- `Fix ALL` → 3件すべてを修正
- `Fix #1` → 指定された番号のみ修正

---

### No.5 - `src/provider.py` で `JOIN` が未定義 (静的解析で検出)
**概要:** `load_error_analysis_records` 内で `JOIN.LEFT_OUTER` を使用しているが、`peewee.JOIN` がインポートされていない。
**修正:** `from peewee import JOIN` を追加。

### No.6 - `antigravity_runner.py` でメソッド重複・ゴミコード (静的解析で検出)
**概要:** `analyze` メソッドが二重定義されており、古い実装や思考過程のテキストがファイル内に残存していた。
**修正:** 重複定義とゴミコードを削除。

### No.7 - `analyzer.py` の `calculate_scores` 呼び出しエラー (自己診断で検出)
**概要:** `AnalysisEngine.calculate_scores` が `style` 引数を受け取らなくなったが、`StockAnalyzer` からまだ渡されており `TypeError` が発生。
**修正:** `style=style` 引数を削除。

### No.8 - `run` メソッド内の未定義メソッド呼び出し
**概要:** `ingest` モードで `_ingest_and_export` を呼んでいたが未定義。実際は `ingest` メソッドが存在。
**修正:** `self.ingest(...)` を呼ぶように修正。修理モード(`repair`)は実装が見当たらないため一時無効化。

## 品質向上施策の実施
**1. 静的解析の実施:** `flake8`, `pylint` を実行し、上記の問題を修正。
**2. スモークテストの追加:** `self_diagnostic.py` に `TestAntigravitySmoke` クラスを追加。全戦略(`turnaround_spec`含む)に対して `extract` モードのDry Runを行い、クラッシュしないことを保証。

```python
# スモークテスト結果 (v3.6)
Runner Smoke Test -> ALL OK
```
## 2025-12-25 障害レポート

* **検出時刻:** 17:33
* **通番:** No.1
* **不具合の概要:** value_strict 戦略の抽出結果が0件となる。
* **原因の提示:** 
    1.  グローバル設定の  が 60 に設定されている。
    2.   戦略の  が 0 であり、かつ加点閾値（thresholds）が非常に厳格。
    3.  全条件（Current Ratio 150%, Quick Ratio 100%等）を満たす374銘柄のうち、最高スコアが 58.5点 であり、しきい値の 60点 に届かない。
* **影響 (Impact):** 本来抽出されるべき優良な割安銘柄がすべてフィルタリングで脱落している。
* **修正案 (Proposed Fix):** 
    - 案A:  の  を 0 から 20 程度に引き上げる。
    - 案B: グローバルな  を 50 程度に緩和する。
    - 案C:  の加点閾値（thresholds）を緩和する。
