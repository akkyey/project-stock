# 2026-01-05 障害レポート

## 検出された不具合一覧

| No. | 検出時刻 | 概要                                                             | 原因                                                             | 影響                                    | 修正案                                  | Status     |
| --- | -------- | ---------------------------------------------------------------- | ---------------------------------------------------------------- | --------------------------------------- | --------------------------------------- | ---------- |
| 1   | 17:15    | `test_ai_agent.py` テスト失敗                                    | `AIAgent` コンストラクタのシグネチャ変更により旧テストが動作せず | テスト失敗、カバレッジ低下              | テストを最新APIに合わせて修正           | ✅ Resolved |
| 2   | 17:15    | `test_execute_with_candidates` 出力ファイル未生成                | `asyncio.to_thread` のモック不足                                 | テスト失敗                              | モック追加                              | ✅ Resolved |
| 3   | 17:15    | `test_execute_processes_candidates` AI分析未実行                 | `DataProvider`/`StockDatabase` のパッチターゲット誤り            | テスト失敗                              | パッチターゲット修正                    | ✅ Resolved |
| 4   | 17:15    | `test_orchestrator_daily_flow` レポート未生成                    | `test_config` の `db_file`/`output_dir` 設定不備                 | テスト失敗                              | 設定修正                                | ✅ Resolved |
| 5   | 17:25    | `equity_auditor.py` で `debug_mode` が `KeyManager` に伝播しない | `agent.debug_mode=True` 設定後も `agent.key_manager` は未更新    | デバッグ時にも実APIがコールされる可能性 | `key_manager.debug_mode` も明示的に設定 | ✅ Resolved |
| 6   | 17:27    | `orchestrator.py` を直接実行できない                             | `if __name__ == "__main__":` ブロック未定義                      | CLI実行不可                             | メイン実行ブロック追加                  | ✅ Resolved |
| 7   | 17:30    | `_execute_equity_auditor` で `equity_auditor.py` が見つからない  | 相対パス `equity_auditor.py` で呼び出し                          | サブプロセス失敗                        | 絶対パスに修正                          | ✅ Resolved |

## 未解決の警告 (対応推奨)

| No. | 概要                                                                          | 対応時期                     |
| --- | ----------------------------------------------------------------------------- | ---------------------------- |
| W1  | `PydanticDeprecatedSince20`: `StockAnalysisData` の class-based config 非推奨 | 次回Pydanticアップデート前   |
| W2  | `FutureWarning`: `result_writer.py` の `.fillna()` ダウンキャスト非推奨       | Pandas次バージョンリリース前 |
| W3  | `FOREIGN KEY constraint failed`: DB Maintenance時のエラー                     | 中優先度（調査必要）         |

## 検証結果

- **週次処理 (`weekly --debug`)**: ✅ 正常完了。API呼び出し 0件（モック動作確認）
- **日次処理 (`daily --debug`)**: ✅ 正常完了。API呼び出し 0件（モック動作確認）

## 詳細コンテキスト
- **実行環境**: `/home/irom/project-stock2` (親リポジトリルート)
- **コマンド**: `pytest --cov=stock-analyzer4/src tests/test_*.py`
- **結果**: 206 Passed, 5 Failed
- **カバレッジ**: 全体 80%
