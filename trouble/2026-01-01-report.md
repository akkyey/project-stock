# 障害レポート (2026-01-01)

## 検出された不具合一覧

| 検出時刻 | 通番 | 不具合の概要                                                | 原因の提示                                           | 影響 (Impact)                                                | 修正案 (Proposed Fix)                                     |
| :------- | :--- | :---------------------------------------------------------- | :--------------------------------------------------- | :----------------------------------------------------------- | :-------------------------------------------------------- |
| 12:40    | No.1 | `ScoringEngine` で `_max` フィルターが無視される            | `filter_and_rank` 内のキー置換と参照ロジックの不整合 | 上限（割高）銘柄を正しく除外できず、投資判断の精度が低下する | `_max` 指定時の分岐を修正し、正しく上限比較 (`<=`) を行う |
| 12:40    | No.2 | `ValidationEngine` が欠損データや異常値を正しく検知できない | `validate_stock_data` でチェックロジックが未統合     | 分析品質の低下、およびデータ不備によるシステム不安定化       | バリデーションフローを見直し、各チェックを確実に統合する  |

## 詳細分析 - No.1: ScoringEngine Filter Bug
`src/calc/engine.py` L180-185:
```python
            if key.endswith('_max'):
                col = key.replace('_max', '')
                if col in candidates.columns:
                    candidates = candidates[candidates[col] <= val]
            else:
                candidates = candidates[candidates[key] >= val]
```
この比較が行われているはずですが、テスト `test_filter_and_rank_global_filters` で `per_max: 30` を指定しても `per: 35.0` が残っています。
推測：`val` の値の取り方、またはデータ型変換の問題。

## 詳細分析 - No.2: ValidationEngine Integration Bug
`src/validation_engine.py` にある `validate_stock_data` が、旧 `DataValidator` のロミロミしたロジックを正しく反映していない可能性があります。

---
## 対応結果 (2026-01-01 13:40)
- **No.1 (ScoringEngine)**: 解決済み。`_max` フィルターの比較演算子を修正し、テストパスを確認。
- **No.2 (ValidationEngine)**: 解決済み。旧ロジックを統合し、`self_diagnostic.py` での検証も完了。
- **その他**: Mypy 対応過程で混入した `src/models.py` のインポートエラーも修正済み。

全項目修正完了。

---

## 追加障害 (2026-01-01 19:30頃検出)

### 検出された不具合一覧

| 検出時刻 | 通番 | 不具合の概要                                               | 原因の提示                                       | 影響 (Impact)                          | 修正案 (Proposed Fix)        |
| :------- | :--- | :--------------------------------------------------------- | :----------------------------------------------- | :------------------------------------- | :--------------------------- |
| 19:30    | No.3 | turnaround_spec戦略でPER正常銘柄にも「PER is NaN」と誤表示 | `prompt_builder.py` で無条件に固定メッセージ追加 | AIが正常データを欠損と誤認識           | バリデーションデータ完全性   |
| 19:30    | No.4 | バリデーションが機能せず欠損銘柄が候補に残る               | `orchestrator.py` で元データをマージせず         | Critical欠損銘柄が分析対象に含まれる   | 元MarketDataのマージ処理追加 |
| 19:30    | No.5 | ROE欠損銘柄がランキング上位に来やすい                      | `turnaround.py` でROE欠損ペナルティなし          | 財務健全な銘柄より欠損銘柄が優先される | ROE欠損ペナルティ追加        |

### 問題の発見経緯
- ユーザーが週次レポートで「ROE欠損」によるスキップが多発していることを報告
- 調査の結果、MarketDataにはROEが存在するのに、AIが「データ欠損」とコメント
- 根本原因は設計時の潜在障害（リファクタ時にコピーされたバグ）

### 対応結果 (2026-01-01 19:50)
- **No.3**: 解決済み。PER条件判定追加。
- **No.4**: 解決済み。元データマージ処理追加。
- **No.5**: 解決済み。ROE欠損ペナルティ追加。

検認により、ROE欠損銘柄のスコアが適切に低下し、Top10には全てROE正常銘柄が入ることを確認。

---

### 追加障害 (2026-01-01 21:00頃検出)

| 検出時刻 | 通番 | 不具合の概要                         | 原因の提示                        | 影響 (Impact)                              | 修正案 (Proposed Fix)                |
| :------- | :--- | :----------------------------------- | :-------------------------------- | :----------------------------------------- | :----------------------------------- |
| 21:00    | No.6 | PERがNaNの場合に動的プロンプトが不発 | NaNが `per_val <= 0` で比較不能   | 損失銘柄なのに「収益あり」人格で分析される | `pd.isna` を使用した厳密な判定へ修正 |
| 21:00    | No.7 | 自己資本比率欠損により週次処理が停止 | Yahoo側のデータ欠損かフェッチ漏れ | 自動修復ループに陥り、レポートが生成不可   | 一時的にチェックを警告に格下げ       |
| 21:00    | No.8 | turnaround_specのPERがAI対象外設定   | `config.yaml` のハードコード      | 収益改善銘柄のPERをAIが分析できない        | 設定の `ai_prompt_excludes` から削除 |

### 対応結果 (2026-01-01 22:00)
- **No.6**: 修正済み。`pandas.isna` を導入。
- **No.7**: 修正済み。`orchestrator.py` のチェックロジックを緩和。
- **No.8**: 修正済み。`config.yaml` を更新。
