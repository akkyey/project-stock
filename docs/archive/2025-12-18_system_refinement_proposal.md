# プロポーサル: システム洗練化 (CSV廃止・手動ツールDB統合)

## 1. 目的
カバレッジ向上タスクにより、DB基盤の安定性が確認されました。本プロポーサルでは、以下の2点を通じてシステムのアーキテクチャをDB中心に集約（Single Source of Truth）し、保守性とユーザビリティを向上させます。

1.  **CSVモードの完全廃止**: `analyzer.py` 内に残存する「CSVロード想定のロジック」を排除し、コードを純粋化する。
2.  **`manual_runner.py` のDB統合**: 手動分析ツールを現在のDB基盤に接続し、データのロードおよび結果の保存を同期させる。

---

## 2. 提案内容

### 2.1 [Cleanup] `src/analyzer.py` の整理
*   **デッドコードの削除**: 旧 `DBManager` のインポートや、古いパス設定のコメント（[Deleted]マークのあるものなど）を完全に削除。
*   **ロジックの単純化**: `process_single_stock` 内にある「`market_data_id` がない場合の検索・フォールバック処理」を削除。実行は常にDBに登録されたデータ（`market_data_id` 保持）を前提とする。

### 2.2 [Feature] `manual_runner.py` のDB連携強化
*   **データロードのDB化**: 特定コード入力時、DBから最新の市況（`market_data`）と銘柄情報（`stocks`）を抽出するように変更。
*   **AIキャッシュの活用**: 手動入力前に、DB内に既存のAI分析結果（`row_hash` が一致するもの）があるか自動チェックし、あれば提示する。
*   **分析結果のDB同期**: 手動で入力した AI sentiment/reason/risk を、DBの `analysis_results` テーブルへ自動的に保存（Upsert）する機能を追加。これにより、手動分析結果も Web UI やレポート出力に反映されるようになる。

---

## 3. メリット
*   **整合性**: 手動分析結果と自動分析結果が同じDBで管理され、データの乖離がなくなる。
*   **効率性**: DBにある最新の市況データを即座に手動分析に利用できる。
*   **保守性**: `analyzer.py` のロジックがシンプルになり、デッドコードによる混乱がなくなる。

---

## 4. 影響範囲
*   **`src/analyzer.py`**: ロジックの削除のみ。
*   **`manual_runner.py`**: 大幅な刷新。
*   **データ構造**: 既存のDBテーブルスキーマに変更は不要。

---

## 5. 実施スケジュール
1.  プロポーサル承認
2.  `analyzer.py` のクリーンアップ
3.  `manual_runner.py` のDB統合実装
4.  動作検証（`self_diagnostic.py` および手動実行確認）
5.  完了報告
