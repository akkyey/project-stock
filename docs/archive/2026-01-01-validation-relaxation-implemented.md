# [Proposal] バリデーション基準の緩和と「Relaxed Mode」の導入 (v12.4)

## 1. 背景と課題 (Background & Limit)
v12.0 へのリファクタリングにおいて、データ品質を保証するために `ValidationEngine` によるチェックを厳格化しました。
しかし、現在の実装では「セクターポリシーで明示的に許可 (`na_allowed`) されていない限り、1つでも指標が欠損していると分析をスキップする」という挙動になっています。

これにより、自己資本比率 (`equity_ratio`) や売上高成長率 (`sales_growth`) など、AI が文脈から補完あるいは「不明」として扱えるはずの軽微な欠損でも分析が行われない（[ANALYSIS SKIPPED]）事象が発生しており、ユーザー体験を損なっています（デグレード）。

## 2. 提案仕様: バリデーション階層化 (Tiered Validation)

単純な緩和ではなく、指標の重要度に応じて 2つの Tier (階層) に分類し、制御をメリハリ付けします。
ユーザー指摘に基づき、基本的な財務指標（PER, ROE等）は欠損していれば「データ破壊」とみなし、分析をスキップします。

### Tier 1: Critical (必須) - 分析スキップ
このレベルの欠損は、企業の存続性や分析の根幹に関わるため、**AI分析をスキップ (Analysis Skipped)** します。
これらの指標は、財務三表 (BS/PL/CF) が正しく取得できていれば必ず算出できるはずのものです。これらが欠損しているということは、**元データ（財務諸表）自体が欠落・破損している**と判断します。

| 指標名                            | 理由                                                |
| :-------------------------------- | :-------------------------------------------------- |
| **Stock Code / Name / Price**     | 分析対象の特定および現在価値の評価に不可欠。        |
| **Equity Ratio (自己資本比率)**   | 倒産リスク評価の最重要指標。(BS由来)                |
| **Operating CF (営業CF)**         | キャッシュフロー評価の根幹。(CF由来)                |
| **Operating Margin (営業利益率)** | 本業の収益性。(PL由来)                              |
| **PER / PBR / ROE / ROA**         | バリュエーションおよび効率性の基本指標。(PL/BS由来) |

※ **注意**: 「赤字でPERが算出不可（負の値）」の場合は「欠損」とは扱わず、分析対象とします。ここで言う「欠損」とは、売上や利益のデータそのものが存在せず、計算不能(`None`)な状態を指します。

### Tier 2: Reference (参考) - 許容 (Info)
欠損していても分析の大勢には影響しない、あるいは代替指標で推測可能なもの。
特段の警告なし（または軽いInfoレベル）で分析を通します。

| 指標名                              | 扱い                                                     |
| :---------------------------------- | :------------------------------------------------------- |
| **Sales Growth (売上成長率)**       | 過去データ不足の場合は「不明」として扱う。               |
| **Technical Indicators (RSI/MACD)** | テクニカル分析のみスキップし、ファンダメンタルズで評価。 |
| **Dividend Yield (配当利回り)**     | 無配当として扱うか、N/Aとして表示。                      |

## 3. 実装アプローチ

`src/validation_engine.py` を改修し、上記のTier判定ロジックを実装します。

1.  **Strict Mode (既存)**: 現状維持（変更なし）。
2.  **Tiered Mode (新規)**: 
    *   Tier 1 (Critical) が1つでも欠損 -> **Skip (False)**
    *   Tier 2 (Reference) の欠損 -> **Allow (True)**
    *   ※ DQF警告は「Tier 2 の参考指標欠損」や「Tier 1 指標の異常値（マイナスPER等）」に対して付与する形に変更。

`config.yaml` の `validation.mode` を `tiered` (default) に設定します。

## 4. 検証 (Verification)
1. `ValidationEngine` の単体テストを追加し、Strict/Tiered 別に挙動を確認する。
2. データ欠損を含む銘柄に対し `analyze` コマンドを実行し、[ANALYSIS SKIPPED] ではなく分析結果（AIの警告付きコメント）が生成されることを確認する。
