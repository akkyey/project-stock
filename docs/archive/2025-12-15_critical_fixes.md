# プロポーサル: 安定性と整合性のための緊急修正 (v3.7)

**作成日**: 2025-12-15
**ステータス**: 提案中

## 背景
v3.7の目標である「APIレート制限回避のための順次処理移行」に対し、現状の実装には並列処理が残存しており、ドキュメントと実装の間に重大な矛盾が生じています。また、危険なツールスクリプトの存在や、データ整合性に関する不備も確認されました。これらを解消し、システムの安定稼働を実現するための修正を提案します。

## 課題と解決策

### 1. 【クリティカル】設計方針と実装の矛盾 (並列処理 vs 順次処理)
**課題**:
ドキュメントでは「順次処理への移行」を謳っていますが、`stock_analyzer.py` の実態は `ThreadPoolExecutor` を使用した並列処理のままです。これにより、Gemini API や Yahoo Finance へのアクセス過多（429エラー）が回避できていません。
**解決策**:
* `stock_analyzer.py` を完全な「順次処理（シングルスレッド）」に書き換えます。
* `ThreadPoolExecutor` を廃止し、単純な `for` ループで1件ずつ処理・保存・待機を行う構造にします。
* `--workers` オプションは廃止（または非推奨化）します。

### 2. ツールスクリプトの危険性
**課題**:
`tools/apply_optimization.py` 等が、ソースコード全体をハードコードされた文字列で上書きする仕様になっています。これにより、開発者が行ったバグ修正や機能追加が消失する「先祖返り」のリスクが極めて高い状態です。
**解決策**:
* これらのスクリプトをリネーム（例: `_deprecated_apply_optimization.py`）し、誤って実行されないようにします。
* コードの変更はGitによるバージョン管理のみで行う運用に統一します。

### 3. クラス名と実態の乖離 (`ExcelWriter`)
**課題**:
クラス名が `ExcelWriter` であるにもかかわらず、実態は「CSVファイル」を出力しています。これは保守性を損ない、後続の処理（Excel変換ツール等）でトラブルの原因となります。
**解決策**:
* クラス名を `ResultWriter` に変更し、実態（CSV/Report出力）に即した名前にします。

### 4. データベースのデータ整合性 (`analysis_results`)
**課題**:
`analysis_results` テーブルに重複チェック（ユニーク制約）がなく、再実行のたびに同じ銘柄・戦略の分析結果が重複して蓄積されます。
**解決策**:
* `market_data_id` と `strategy_name` の組み合わせに対するユニークインデックスを追加します。
* データ保存時に `INSERT OR REPLACE` (UPSERT) を使用するように修正します。

### 5. 環境変数の読み込み漏れ
**課題**:
`.env` ファイルにAPIキーを記述しても、明示的にロードされていないため読み込まれない可能性があります。
**解決策**:
* `stock_analyzer.py` の起動時に `load_dotenv()` を実行するようにします。

## 実装計画

1. **`stock_analyzer.py` の順次処理化**
2. **危険なツールスクリプトの無効化**
3. **`database.py` へのユニーク制約/UPSERT導入**
4. **`ExcelWriter` の `ResultWriter` へのリネーム**
5. **その他バグ修正 (`ai_agent.py` env load, `calc.py` None check)**

詳細は `implementation_plan.md` を参照してください。
