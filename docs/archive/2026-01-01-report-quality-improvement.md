# AIレポート品質向上プロポーサル (revised - Phased Implementation)

## 目的
AIによる銘柄分析レポートの単調さを解消し、データ欠損時でも「厳格な番人」としての人格を維持しながら、自然でバリエーション豊かな情報を生成・安定出力するための改善案です。

---

## 段階的実装計画 (Phased Implementation Plan)
都度、実行の許可をいただきながら、以下の4フェーズで進めます。

### 【Phase 1】基盤強化とデータ監査 (Data & Validation Base)
まずは「0」と「欠損」の区別を明確にし、出力の安定性を支えるバリデーションを実装します。
1. **データ監査 (Data Audit)**: 既存DBを走査し「0」と「None」の混同状況を確認・報告。
2. **`validator.py` 修正**: 欠損判定を厳密化。
3. **`AIAgent._validate_response` 強化**: JSON構造・サマリ構文の厳格なチェックとリトライロジックの実装。
4. **`Reporter` 修正**: 改行除去と「｜」区切りに対応したサニタイズ処理。
**→ 完了後、テスト結果を報告し Phase 2 の許可を仰ぐ。**

### 【Phase 2】プロンプト更新と欠損分類 (Prompt & Deficiency Classification)
新しいサマリ形式をAIに学習させ、データ欠損時の説明力を高めます。
1. **`AIAgent` 修正**: `deficiency_type` (CF欠損型等) の判定とプロンプト注入。
2. **`ai_prompts.yaml` 更新**:
   - 3行サマリの「｜」区切りと1行表示の指示。
   - 欠損分類に応じた定性分析の強化指示。
**→ 小規模なテスト生成結果を報告し、文言のバリエーションが適切かユーザー確認を受ける。**

### 【Phase 3】Bearish判定強化と例外ルール (Strict Logic & Exceptions)
分析の説得力を高め、特定の条件下での柔軟性を持たせます。
1. **`ai_prompts.yaml` 更新**:
   - Bearish 時の数値根拠（閾値違反）引用の義務化。
   - 例外ルール（PBR割安等による引き上げ）の追加。
   - 「番人」の人格を保つための固定フレーズ（枕詞）の導入。
**→ 実際の分析結果（Bearish/Neutral）を提示し、ロジックの妥当性を確認。**

### 【Phase 4】統合検証と仕上げ (Integration & Polish)
システム全体としての安定性と出力品質を最終確認します。
1. **全戦略スモークテスト**: `self_diagnostic.py` を含む全テストの実行。
2. **長期・大量分析シミュレーション**: API制限やリトライロジックの耐久テスト。
3. **最終ドキュメント更新**: `history`, `backlog` への記録。
**→ 最終レポートを提示し、タスク完了を報告。**

---

## Proposed Changes (Details)

### 1. サマリ仕様
- **フォーマット**: `【結論】XX。｜【強み】YY。｜【懸念】ZZ。` (横並び1行)
- **区切り記号**: `｜` (全角縦棒)

### 2. 「0」と「None」の扱い
- `_is_empty` ロジックを再定義し、`0` を有効な数値として、`None` を欠損として明確に区別。

### 3. バリデーション項目
- `ai_sentiment` Enum、`ai_summary` 構文（順序・記号・改行なし）、`ai_detail_body` 構造（①〜⑦）。

---

## 結果の整合性検証と妥当性評価 (Result Integrity & Evaluation)
行動規範（`GEMINI.md` 第12条）に基づき、以下の検証を徹底します。

1. **結果の一致確認**:
   - リファクタリングや基盤コードの改変箇所については、同一の入力データを用い、改修前後で最終出力（DBレコード、CSVデータ）が完全に一致することを物理的に検証します。
2. **仕様変更に伴う差異の報告**:
   - プロンプト更新や判定ロジックの変更により「意図的に結果が変わる」場合（例：サマリの区切り文字、例外ルールによるセンチメントの変化）は、その理由と妥当性を詳細に説明し、ユーザーの承認を得ます。
3. **独自判断の禁止**:
   - 僅かな差異であっても、ユーザーの許可なく「問題なし」と判断して作業を続行しません。

---

## Verification Plan
各フェーズ完了ごとに、指定されたテストや目視確認を実施します。
1. **Phase 1**: ユニットテストによる構文チェック・リトライ動作の確認。
2. **Phase 2-3**: 実際のAI生成物による日本語表現・ロジックの定性評価。
3. **Phase 4**: フルテストスイートによる回帰テスト。
