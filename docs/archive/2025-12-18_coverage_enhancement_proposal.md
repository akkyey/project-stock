## カバレッジ向上提案書

### 1. 目的

本提案は、現状のカバレッジテスト結果でカバレッジが低いと示されたモジュール群（`src/ai_agent.py`, `src/calc.py`, `src/data_fetcher.py`, `src/database.py`）について、カバレッジを無理のない範囲で向上させるための具体的なテスト戦略を提示することを目的とします。

### 2. 現状の課題

カバレッジレポートによると、以下のモジュールでカバレッジが低くなっています。

*   `src/ai_agent.py`: 42%
*   `src/calc.py`: 56%
*   `src/data_fetcher.py`: 55%
*   `src/database.py`: 58%

これらのモジュールは、外部APIへの依存、複雑なビジネスロジック、データベース操作、外部サービスとの連携といった特性を持っており、テストケースの作成が難しい要因となっています。

### 3. 各モジュールに対するテスト戦略

#### 3.1. `src/ai_agent.py` (カバレッジ 42%)

*   **アプローチ:** 外部API（Gemini）への依存を切り離し、モック（模擬）を用いることで、ロジック部分のテストを強化します。
*   **具体的なテスト内容:**
    *   **APIモック化:** Pythonの `unittest.mock` 等を使用し、`genai.GenerativeModel` や `model.generate_content` の呼び出しをモック化します。これにより、実際のAPI通信なしで、プロンプト生成、レスポンスパース、エラーハンドリングのテストを実行可能にします。
    *   **プロンプト生成テスト (`_create_prompt`):** 様々な入力データに対して、期待通りのプロンプト文字列が生成されることを確認します。
    *   **レスポンスパーステスト (`_parse_response`):** 有効なJSON、無効なJSON、エラーレスポンスなど、多様なAIからのレスポンス形式をパースする処理が正しく動作することを確認します。
    *   **エラーハンドリングテスト:** APIエラー（`ResourceExhausted`, `ServiceUnavailable` など）をシミュレートし、`_generate_content_with_retry` および `analyze` メソッドがこれらのエラーを適切に捕捉・処理するかを検証します。
    *   **デバッグモードテスト:** `debug_mode=True` の場合に、モックレスポンスが返却されることを確認します。

#### 3.2. `src/calc.py` (カバレッジ 56%)

*   **アプローチ:** 複雑なスコアリングロジックの各分岐を網羅する、詳細な単体テストを作成します。
*   **具体的なテスト内容:**
    *   **`calc_quant_score` の網羅的テスト:**
        *   各指標（PER, PBR, ROEなど）について、閾値の上下限、閾値ちょうどの値、無効な入力値（`None`, 文字列など）を与え、スコアが正しく計算されるか確認します。
        *   `lower_is_better` が `True` および `False` の両方のケースをテストします。
        *   配当利回り、配当性向、営業キャッシュフローなどの特殊ロジックが正しく評価されるか検証します。
        *   `pd.DataFrame` と辞書（`dict`）の両方の入力タイプに対応したテストを作成します。
    *   **`calc_v2_score` の網羅的テスト:**
        *   様々な `style` パラメータ（例: `value_balanced`）とその重み付け（`weight_fund`, `weight_tech`）が正しく適用されるかテストします。
        *   MACD, RSI, Trend Signal などのテクニカル指標に対するスコアリングロジックの正確性を検証します。
        *   マクロ/セクター調整ロジックが意図通りに機能するか確認します。
        *   `score_long`, `score_short`, `score_gap` の計算結果が正しいことを検証します。
    *   **設定値テスト:** `self.config` から読み込まれるスコアリング設定（`scoring`, `scoring_v2`）が、計算ロジックに正しく適用されるかを確認します。

#### 3.3. `src/data_fetcher.py` (カバレッジ 55%)

*   **アプローチ:** 外部API（yfinance, JPX）やネットワーク依存部分をモック化し、データ取得・処理・エラーハンドリングロジックのテストを強化します。
*   **具体的なテスト内容:**
    *   **外部APIモック化:** `yfinance.Ticker`、`requests.Session`、`pd.read_excel` などの外部ライブラリの呼び出しをモックします。
    *   **`fetch_jpx_list` のテスト:**
        *   JPX APIが成功した場合のレスポンスをモックし、データが正しくパース、フィルタリングされるか確認します。
        *   JPX APIエラーをシミュレートし、バックアップファイルからのフォールバックロジックが正常に機能するかテストします。
    *   **`_fetch_single_stock` のテスト:**
        *   `_get_ticker_info_safe` への呼び出しをモックし、正常な情報、情報不足、エラーレスポンスなど、様々なケースをテストします。
        *   `stock.history` の呼び出しをモックし、過去データからテクニカル指標（MACD, RSIなど）が正しく計算されるか確認します。
        *   データに欠損がある場合や、予期しない形式の場合のハンドリングをテストします。
    *   **`_calc_technical_indicators` の単体テスト:** この関数を独立させ、サンプルデータを用いてMACD、RSI、トレンド計算が正確に行われることを確認します。
    *   **リトライロジックテスト:** `retry_with_backoff` デコレータが適用されている箇所で、意図的にエラーを発生させ、リトライが期待通りに機能するかをテストします。

#### 3.4. `src/database.py` (カバレッジ 58%)

*   **アプローチ:** テスト実行時にインメモリSQLiteデータベースを使用し、データベース操作、スキーママイグレーション、データ整合性のテストを効率的に行います。
*   **具体的なテスト内容:**
    *   **インメモリDBの利用:** テスト実行時には、実際のファイルDB (`data/stock_master.db`) ではなく、`:memory:` を使用します。これにより、テストの高速化と環境依存性の排除を図ります。
    *   **スキーマ初期化・マイグレーションテスト:**
        *   `_init_db` メソッドが、テーブル（`stocks`, `market_data`, `analysis_results`）を正しく作成することを確認します。
        *   `_migrate_v33_schema` のテスト: カラムが存在しない状態のデータベース（インメモリ）を用意し、マイグレーションコード実行後に、期待されるカラム（`score_long`, `row_hash` など）が追加されていることを確認します。
    *   **CRUD操作テスト:**
        *   `upsert_stocks`: 新規銘柄の登録、既存銘柄の更新が正しく行われるかテストします。
        *   `upsert_market_data`: 新規レコード挿入、既存レコードの更新（`ON CONFLICT`）、日付の扱い、`fetch_status` の設定などをテストします。
        *   `save_analysis_result`: 分析結果（新しいフィールドを含む）が正しく保存されるか、`row_hash` によるキャッシュロジックが機能するかなどをテストします。
    *   **データ取得メソッドテスト:** `get_market_data_status`, `get_market_data_id`, `get_ai_cache` などのメソッドが、事前にデータを挿入したテストデータベースから、期待通りにデータを検索・取得できることを確認します。

### 4. 実施体制

*   Pythonの標準テストフレームワーク (`unittest` または `pytest`) を使用します。
*   外部依存性のモックには `unittest.mock` ライブラリを活用します。
*   テストコードは、`tests/` ディレクトリ内に、各モジュールに対応する形で追加・整理します。

### 5. 今後の進め方

まずは、最もカバレッジが低い `src/ai_agent.py` または `src/calc.py` から、上記提案に基づいたテストコードの実装に着手するのが効率的と考えられます。

この提案内容について、ご承認いただければ、具体的なテストコードの実装に入りたいと思います。