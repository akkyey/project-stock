# Stock Analyzer v3 æ”¹ä¿®ææ¡ˆ: é †æ¬¡å‡¦ç†ã¸ã®ç§»è¡Œã¨ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹å¯¾å¿œ

**ä½œæˆæ—¥:** 2025-12-14
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:** ææ¡ˆä¸­

## 1. èƒŒæ™¯ã¨ç›®çš„

### ç¾çŠ¶ã®èª²é¡Œ
ç¾åœ¨ã€`stock_analyzer.py` ã¯ `ThreadPoolExecutor` ã‚’ç”¨ã„ãŸä¸¦åˆ—å‡¦ç†ï¼ˆ`--workers` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ãŒã€ä»¥ä¸‹ã®å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚

1.  **APIãƒ¬ãƒ¼ãƒˆåˆ¶é™ (429/401ã‚¨ãƒ©ãƒ¼):** ä¸¦åˆ—ã‚¢ã‚¯ã‚»ã‚¹ã«ã‚ˆã‚Š yfinance ç­‰ã®å¤–éƒ¨APIã¸ã®è² è·ãŒé›†ä¸­ã—ã€ã‚¨ãƒ©ãƒ¼ãŒé »ç™ºã—ã¦ãƒ‡ãƒ¼ã‚¿å–å¾—ã®å®‰å®šæ€§ãŒä½ä¸‹ã—ã¦ã„ã¾ã™ã€‚
2.  **ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®æ‡¸å¿µ:** ä¸¦åˆ—æ›¸ãè¾¼ã¿æ™‚ã®ç«¶åˆã‚„ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®è¤‡é›‘ã•ã«ã‚ˆã‚Šã€ãƒ‡ãƒ¼ã‚¿ã®ä¿¡é ¼æ€§ãŒæãªã‚ã‚Œã‚‹ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚
3.  **ç§»è¡Œéæ¸¡æœŸã®é‹ç”¨:** CSVã‹ã‚‰DB (SQLite3) ã¸ã®ç§»è¡Œä¸­ã§ã™ãŒã€ä¸¡æ–¹ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’æŸ”è»Ÿã«åˆ‡ã‚Šæ›¿ãˆã¦æ¤œè¨¼ã™ã‚‹ä»•çµ„ã¿ãŒä¸ååˆ†ã§ã™ã€‚

### æ”¹ä¿®æ–¹é‡
æœ¬ææ¡ˆã§ã¯ã€ä»¥ä¸‹ã®3ç‚¹ã‚’ä¸»è»¸ã«æ”¹ä¿®ã‚’è¡Œã„ã¾ã™ã€‚

1.  **ä¸¦åˆ—å‡¦ç†ã®å®Œå…¨å»ƒæ­¢:** `stock_analyzer.py` ã‚’å …å®Ÿãªé †æ¬¡å‡¦ç†ï¼ˆForãƒ«ãƒ¼ãƒ—ï¼‰ã¸æ›¸ãæ›ãˆã€å®‰å®šæ€§ã‚’æœ€å„ªå…ˆã—ã¾ã™ã€‚
2.  **CSV/DB ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰é‹ç”¨:** å¼•æ•° `--source` ã«ã‚ˆã‚Šãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’åˆ‡ã‚Šæ›¿ãˆå¯èƒ½ã«ã—ã€æ–°æ—§ãƒ­ã‚¸ãƒƒã‚¯ã®æ¯”è¼ƒæ¤œè¨¼ï¼ˆãƒ‘ãƒ©ãƒ¬ãƒ«ãƒ©ãƒ³ï¼‰ã‚’å®¹æ˜“ã«ã—ã¾ã™ã€‚
3.  **å®‰å…¨æ€§é‡è¦–ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°:** ã‚¨ãƒ©ãƒ¼ã‚’æ¡ã‚Šã¤ã¶ã•ãšã€è©³ç´°ãªãƒ­ã‚°ã‚’æ®‹ã—ã¦å‡¦ç†ã‚’ç¶™ç¶šã™ã‚‹ä»•çµ„ã¿ã‚’å¼·åŒ–ã—ã¾ã™ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€**ã€ŒFetchingï¼ˆãƒ‡ãƒ¼ã‚¿å–å¾—ï¼‰ã€ã¨ã€ŒAnalyzingï¼ˆåˆ†æï¼‰ã€ã®è²¬å‹™ã‚’æ˜ç¢ºã«åˆ†é›¢**ã—ã€`stock_analyzer.py` ã¯ã€Œåé›†æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã™ã‚‹åˆ†æã€ã«é›†ä¸­ã™ã‚‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¸ç§»è¡Œã—ã¾ã™ã€‚

---

## 2. å…·ä½“çš„ãªä¿®æ­£ã‚¿ã‚¹ã‚¯

### Task 1: stock_analyzer.py ã®é †æ¬¡å‡¦ç†åŒ–ã¨ãƒ¢ãƒ¼ãƒ‰åˆ†å²

`stock_analyzer.py` ã®æ§‹é€ ã‚’æ ¹æœ¬çš„ã«å¤‰æ›´ã—ã¾ã™ã€‚

*   **å‰Šé™¤:** `concurrent.futures`, `ThreadPoolExecutor`, `--workers` å¼•æ•°ã€‚
*   **è¿½åŠ :** `--source` å¼•æ•° (choices: `['db', 'csv']`, default: `db`)ã€‚
*   **å¤‰æ›´:**
    *   **ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰:** å‡¦ç†é–‹å§‹æ™‚ã«ä¸€æ‹¬ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
        *   `--source db`: `analyzer.load_data_from_db()` ã‚’ä½¿ç”¨ï¼ˆ`collector.py` ã§åé›†æ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ï¼‰ã€‚
        *   `--source csv`: `analyzer.load_data()` ã‚’ä½¿ç”¨ï¼ˆ`fetch_data.py` ã§åé›†æ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ï¼‰ã€‚
    *   **ãƒ«ãƒ¼ãƒ—å‡¦ç†:** ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è¡Œã”ã¨ã«é †æ¬¡å‡¦ç†ã—ã¾ã™ã€‚
    *   **Waitåˆ¶å¾¡:** å¿…è¦ã«å¿œã˜ã¦ãƒ«ãƒ¼ãƒ—å†…ã§ `time.sleep()` ã‚’æŒŸã¿ã€APIè² è·ã‚’åˆ¶å¾¡ã—ã¾ã™ï¼ˆåˆ†æãƒ•ã‚§ãƒ¼ã‚ºã§å¤–éƒ¨APIã‚’å©ãå ´åˆï¼‰ã€‚

**å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸:**

```python
def main():
    parser = argparse.ArgumentParser(description="Stock Analyzer v3 (Sequential)")
    parser.add_argument("--source", choices=['db', 'csv'], default='db', help="Data source")
    # ... ä»–ã®å¼•æ•° ...

    # 1. ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
    if args.source == 'db':
        logger.info("ğŸ“¥ Loading data from Database...")
        df = analyzer.load_data_from_db()
    else:
        logger.info("ğŸ“¥ Loading data from CSV...")
        df = analyzer.load_data()

    # ... ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° ...

    # 2. é †æ¬¡ãƒ«ãƒ¼ãƒ—å‡¦ç†
    for index, row in tqdm(df.iterrows(), total=len(df)):
        try:
            # åˆ†æå‡¦ç†
            analyzer.process_single_stock(row.to_dict(), strategy)
            # è² è·è»½æ¸›ã®ãŸã‚ã®Wait
            time.sleep(0.5)
        except Exception as e:
            logger.error(f"Error processing {row['code']}: {e}")
```

### Task 2: src/analyzer.py ã®ä¾‹å¤–å‡¦ç†ã®å¼·åŒ–

`process_single_stock` ãƒ¡ã‚½ãƒƒãƒ‰å†…ã®DBä¿å­˜å‡¦ç†ã«ãŠã‘ã‚‹ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å¼·åŒ–ã—ã¾ã™ã€‚

*   **å¤‰æ›´ç‚¹:** `db_manager.save_result` å‘¼ã³å‡ºã—æ™‚ã®ä¾‹å¤–å‡¦ç†ã«ã¦ã€`exc_info=True` ã‚’ä»˜ä¸ã—ã€ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’å«ã‚€è©³ç´°ãªãƒ­ã‚°ã‚’å‡ºåŠ›ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€DBãƒ­ãƒƒã‚¯ã‚„æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼ã®åŸå› ç‰¹å®šã‚’å®¹æ˜“ã«ã—ã¾ã™ã€‚

### Task 3: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ•´åˆæ€§ä¿®æ­£

ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã«ä¼´ã„ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¾ã™ã€‚

*   **å¯¾è±¡:** `docs/architecture_ja.md`, `docs/manual_main_ja.md`
*   **å†…å®¹:**
    *   ã€Œä¸¦åˆ—å‡¦ç†ã€ã€Œ--workersã€ã«é–¢ã™ã‚‹è¨˜è¿°ã‚’å‰Šé™¤ã€‚
    *   ã€Œé †æ¬¡å‡¦ç†ã€ã€Œ--source ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€ã®èª¬æ˜ã‚’è¿½åŠ ã€‚
    *   ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã®èª¬æ˜ã‚’ã€Œåé›†(collector/fetch_data) -> åˆ†æ(stock_analyzer)ã€ã¨ã„ã†åˆ†é›¢ãƒ¢ãƒ‡ãƒ«ã«åˆã‚ã›ã¦ä¿®æ­£ã€‚

---

## 3. ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### ãƒ•ã‚§ãƒ¼ã‚º1 (ä»Šå›): å®‰å®šç‰ˆã®å®Ÿè£…
*   ä¸¦åˆ—å‡¦ç†ã‚’å»ƒæ­¢ã—ã€DB/CSVåˆ‡ã‚Šæ›¿ãˆå¯èƒ½ãª `stock_analyzer.py` ã‚’å®Ÿè£…ã€‚
*   ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å¼·åŒ–ã€‚

### ãƒ•ã‚§ãƒ¼ã‚º2 (æ¤œè¨¼): ãƒ‘ãƒ©ãƒ¬ãƒ«ãƒ©ãƒ³æ¤œè¨¼
*   DBãƒ¢ãƒ¼ãƒ‰ã¨CSVãƒ¢ãƒ¼ãƒ‰ã§ãã‚Œãã‚Œåˆ†æã‚’å®Ÿè¡Œã€‚
*   å‡ºåŠ›çµæœ (`analysis_result.csv` vs `db_analysis_result.csv`) ã‚’æ¯”è¼ƒã—ã€ãƒ‡ãƒ¼ã‚¿ã®æ¬ æã‚„è¨ˆç®—çµæœã®å·®ç•°ã‚’ç¢ºèªã€‚

### ãƒ•ã‚§ãƒ¼ã‚º3 (çµ±åˆ): DBå®Œå…¨ç§»è¡Œ
*   æ¤œè¨¼å®Œäº†å¾Œã€CSVç”Ÿæˆãƒ„ãƒ¼ãƒ« (`fetch_data.py`) ãŠã‚ˆã³ `analyzer.load_data()` (CSVèª­ã¿è¾¼ã¿) ã‚’å»ƒæ­¢ã€‚
*   ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ `collector.py` (DBä¿å­˜) -> `stock_analyzer.py` (DBèª­è¾¼) ã«ä¸€æœ¬åŒ–ã€‚
