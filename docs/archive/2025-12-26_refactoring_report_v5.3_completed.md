# Stock Analyzer v5.3 リファクタリング検討レポート

**作成日:** 2025-12-23  
**評価対象:** `/home/irom/stock-analyzer3`

---

## 📊 プロジェクト概要

| 項目             | 値             |
| ---------------- | -------------- |
| ソースファイル数 | 18             |
| 総行数           | 約 2,637 行    |
| テストファイル数 | 38             |
| テストケース数   | 121            |
| カバレッジ       | 87%            |
| テスト成功率     | 100% (121/121) |

---

## 🎯 実用レベル評価

**総合評価: B+ (実用プロダクション相当)**

| 評価項目           | スコア | 評価                   |
| ------------------ | ------ | ---------------------- |
| 機能完成度         | ★★★★☆  | 主要機能は完備         |
| コード品質         | ★★★★☆  | 構造化されている       |
| テストカバレッジ   | ★★★★☆  | 87% (良好)             |
| ドキュメント       | ★★★★☆  | バックログ等充実       |
| 運用準備           | ★★★☆☆  | さらなる改善余地あり   |
| エラーハンドリング | ★★★★☆  | サーキットブレーカー等 |

### 強み
- 2段階分析 (Screening → AI) のワークフロー設計が明確
- API Key ローテーション・サーキットブレーカーなど堅牢性対策が実装済み
- Peewee ORM によるDB管理が適切に実装
- 高いテストカバレッジ (87%)

### 改善を推奨する領域
- 一部のモジュールが大きくなりすぎている (`calc.py`: 454行, `data_fetcher.py`: 377行)
- コード重複箇所の存在
- 型ヒントの不足

---

## 🔍 詳細評価

### 1. 処理の全体最適 (Architecture)

#### 良好な点 ✅
- **責務分離**: `DataProvider`, `AnalysisEngine`, `AIAgent`, `ResultWriter` と役割が明確に分離
- **設定駆動**: `config.yaml` による柔軟な設定管理
- **層構造**: `analyzer.py` がオーケストレーター、専門モジュールが処理を担当

#### 改善提案 📝

| 優先度 | 項目                     | 現状                                        | 提案                                                                     |
| ------ | ------------------------ | ------------------------------------------- | ------------------------------------------------------------------------ |
| 高     | `calc.py` の分割         | 454行の単一ファイル                         | `calc/base.py`, `calc/v2_scoring.py`, `calc/breakdown.py` への分割       |
| 中     | `data_fetcher.py` の分割 | 377行 (JPX取得 + yfinance + テクニカル計算) | `fetcher/jpx.py`, `fetcher/yfinance.py`, `fetcher/technical.py` への分割 |
| 低     | Strategy Pattern         | 戦略ごとのスコアリングが config + if文      | Strategy クラスの導入検討                                                |

### 2. 可読性 (Readability)

#### 良好な点 ✅
- ログメッセージが日本語 + 絵文字で直感的 (例: `✅ Analysis completed`)
- docstring が主要メソッドに付与
- バージョン履歴がコメントで記載 ([v5.3], [v4.12] など)

#### 改善提案 📝

| 優先度 | 項目                         | 現状                                                      | 提案                                             |
| ------ | ---------------------------- | --------------------------------------------------------- | ------------------------------------------------ |
| 高     | 型ヒント不足                 | ほぼ未使用                                                | 主要関数に `-> pd.DataFrame`, `-> dict` 等を追加 |
| 高     | マジックナンバー             | 閾値がハードコード (例: `if growth_rate >= 100.0`)        | 定数クラス or config へ抽出                      |
| 中     | 重複コメント                 | `data_fetcher.py`: L168-174 に同一コメントが2回           | 削除                                             |
| 中     | 重複コード                   | `_calc_v2_vectorized` と `_calc_v2_scalar` のロジック重複 | 共通処理を抽出                                   |
| 低     | `utils.py` 冒頭の import重複 | L1-8 で同一 import が2度記載                              | 削除                                             |

### 3. 処理効率 (Performance)

#### 良好な点 ✅
- ベクトル化計算 (`_calc_v2_vectorized`) による高速処理
- スマートキャッシュによる API コール削減
- インデックス最適化済みの DB 設計

#### 改善提案 📝

| 優先度 | 項目                  | 現状                                                 | 提案                                       | 期待効果         |
| ------ | --------------------- | ---------------------------------------------------- | ------------------------------------------ | ---------------- |
| 中     | 文字列変換の最適化    | `calc.py` で毎回 `.astype(str).str.replace(',', '')` | 前処理で一度だけ実行                       | 計算時間 -10%    |
| 中     | DataFrame コピー削減  | `engine.py`: L18 で `df.copy()`                      | 本当に必要な場合のみコピー                 | メモリ使用量削減 |
| 低     | MACD/RSI 計算の共通化 | `_calc_technical_indicators` で都度計算              | キャッシュ or ライブラリ (TA-Lib) 使用検討 | -                |

### 4. 堅牢性 (Robustness)

#### 良好な点 ✅
- サーキットブレーカーによる API 制限対応
- API キーの自律的除外 (Self-Healing)
- リトライ with バックオフ (`retry_with_backoff` デコレータ)
- エラータイプの分類 (`STATUS_ERROR_QUOTA` 等)

#### 改善提案 📝

| 優先度 | 項目                        | 現状                                   | 提案                                                                    |
| ------ | --------------------------- | -------------------------------------- | ----------------------------------------------------------------------- |
| 高     | 例外の具体化                | `except Exception as e:` が多用        | 特定例外のキャッチ (`requests.RequestError`, `json.JSONDecodeError` 等) |
| 高     | 入力バリデーション          | DataFrame のカラム存在チェックが暗黙的 | 明示的なスキーマ検証 (Pydantic / pandera)                               |
| 中     | config バリデーションの強化 | 起動時のチェックのみ                   | 実行時の設定変更を検知してバリデーション                                |
| 低     | ログレベルの統一            | 一部で `print` 使用 (`utils.py`: L102) | 全て `logger` に統一                                                    |

---

## 🏗️ リファクタリング優先順位

### Phase 1: 緊急対応 (すぐに修正すべき)
1. `utils.py` の重複 import 削除 (L1-8)
2. `data_fetcher.py` の重複行削除 (L311-313)
3. 型ヒントの追加 (主要パブリックメソッド)

### Phase 2: 短期改善 (今後1-2週間)
1. マジックナンバーの定数化 (特に `calc.py` のスコア閾値)
2. `calc.py` の分割 (3ファイル程度に)
3. `_calc_v2_vectorized` と `_calc_v2_scalar` の共通処理抽出

### Phase 3: 中期改善 (今後1ヶ月)
1. `data_fetcher.py` の分割
2. 入力バリデーションの強化 (Pydantic / pandera 導入)
3. Strategy パターンの導入検討

---

## 🗃️ データスキーマの冗長性調査

### 発見された冗長・重複カラム

#### 1. DB (`MarketData` テーブル) - 新旧カラムの併存

| カテゴリ   | 旧カラム (冗長)        | 新カラム (推奨)                                           | 理由                                       |
| ---------- | ---------------------- | --------------------------------------------------------- | ------------------------------------------ |
| Turnaround | `is_turnaround` (Int)  | `turnaround_status` (Text)                                | `turnaround_status` がより詳細な情報を持つ |
| Trend      | `trend_up` (Float/Int) | `trend_score` (Int: 0-4)                                  | `trend_score` は投票システムの完全なスコア |
| Profit     | -                      | `profit_status`, `turnaround_status`, `profit_growth_raw` | 複数のカラムで同じ情報が異なる形式で保持   |

#### 2. CSV出力 - 内部用・デバッグ用カラムの混入

| カラム           | 問題                 | 推奨                             |
| ---------------- | -------------------- | -------------------------------- |
| `_is_cached`     | 内部用フラグ         | CSV出力から除外                  |
| `_cache_label`   | 内部用フラグ         | CSV出力から除外                  |
| `row_hash`       | 内部キャッシュ用     | CSV出力から除外                  |
| `updated_at`     | DB更新タイムスタンプ | ユーザーには不要                 |
| `fetch_status`   | データ取得ステータス | 成功レコードのみ出力するなら不要 |
| `market_data_id` | DB内部ID             | CSV出力から除外                  |

### データスキーマ改善の推奨アクション

| Phase | 内容                                                                               | 影響度 |
| ----- | ---------------------------------------------------------------------------------- | ------ |
| 1     | CSV出力から内部カラム除外 (`_is_cached`, `row_hash` 等)                            | 小     |
| 2     | `calc.py` のロジックを新カラム (`trend_score`, `turnaround_status`) のみ参照に移行 | 中     |
| 3     | レガシーカラム (`is_turnaround`, `trend_up`) をDBから削除                          | 大     |

> [!WARNING]
> **現時点で削除できない理由**: `is_turnaround` と `trend_up` は `calc.py` のスコア計算ロジックで参照されているため、先にロジック移行が必要です。

---

## 🖥️ CLIオプションの冗長性調査

### 現行のCLIエントリポイント

| スクリプト          | 目的       | 主要オプション                                                                  |
| ------------------- | ---------- | ------------------------------------------------------------------------------- |
| `stock_analyzer.py` | 分析実行   | `--stage`, `--strategy`, `--limit`, `--repair`, `--input`, `--debug`, `--style` |
| `collector.py`      | データ収集 | `--limit`, `--force`                                                            |
| `manual_runner.py`  | 対話式分析 | (オプションなし)                                                                |

### 発見された問題

| 優先度 | 項目                                          | 対応             |
| ------ | --------------------------------------------- | ---------------- |
| 高     | `manual_runner.py` の重複エントリポイント削除 | 即時修正         |
| 中     | README.md から `--workers` 記載削除           | ドキュメント更新 |
| 中     | full_context 内の古い使用例更新               | ドキュメント更新 |
| 低     | `--style` の非推奨化検討                      | 将来対応         |

---

## 📝 即時対応推奨の不具合 (4件)

> [!NOTE]
> **2025-12-23 実施済み**: 以下の4件は修正完了。回帰テスト全121件パス確認済み。

| No. | ファイル           | 問題                                           | 行       | 状態     |
| --- | ------------------ | ---------------------------------------------- | -------- | -------- |
| 1   | `utils.py`         | import文が重複                                 | L1-8     | ✅ 修正済 |
| 2   | `data_fetcher.py`  | 'sales' キーが3回重複                          | L311-313 | ✅ 修正済 |
| 3   | `manual_runner.py` | `if __name__ == "__main__":` ブロックが2回重複 | L156-162 | ✅ 修正済 |
| 4   | `README.md`        | 廃止済み `--workers` オプション記載            | L62      | ✅ 修正済 |

---

## まとめ

本プロジェクトは**実用レベルに達しており**、主要機能の実装・テスト・ドキュメントが十分に整備されています。

ただし、継続的な追加開発により一部モジュールが肥大化しており、**関心の分離 (Separation of Concerns)** の観点から `calc.py` と `data_fetcher.py` の分割を推奨します。

また、**型ヒントと入力バリデーションの強化**により、将来の保守性とチーム開発への対応力が向上します。
