# ドキュメント作成: v3.3 高度分析機能の v3.7 アーキテクチャへの統合計画

**作成日**: 2025-12-15
**対象バージョン**: v3.7 (Sequential / DB-based)
**統合元**: v3.3 (Advanced Scoring / Context)

## 概要
本プロポーザルは、現在安定稼働している v3.7 の順次処理アーキテクチャに対し、過去バージョン (v3.3) で設計された高度な分析機能（デュアルスコアリング、マクロ環境補正、投資スタイル選択）を統合するための実装計画を定義します。

## 目的
1. **分析精度の向上**: ファンダメンタルズとテクニカルを分離評価し、より多角的な銘柄選定を可能にする。
2. **市場適用性の強化**: マクロ経済環境（金利、市場トレンド）に応じてスコアを動的に補正する。
3. **柔軟な戦略**: ユーザーが「短期」または「長期」の視点を選択できるようにする。

## 実装詳細

### 1. 設定ファイルの拡張 (`config.yaml`)

`config.yaml` に `scoring_v2` セクションを追加し、スタイル定義とマクロ補正係数を定義します。

```yaml
scoring_v2:
  # マクロ環境設定 (market_context.txt からオーバーライド可能)
  macro:
    sentiment: "neutral" # bullish, bearish, neutral
    interest_rate: "stabilizing" # rising, falling, stabilizing
    active_sector: "Technology" # 注目のセクター

  # スタイル定義 (Fundamentals vs Technicals の重み)
  styles:
    value_balanced: # デフォルト
      weight_fund: 0.7
      weight_tech: 0.3
    short_term_momentum:
      weight_fund: 0.3
      weight_tech: 0.7
    long_term_growth:
      weight_fund: 0.9
      weight_tech: 0.1

  # ポイント定義 (既存の scoring を拡張)
  tech_points:
    macd_bullish: 15
    rsi_oversold: 10
    rsi_overbought: -10
    trend_up: 10
```

### 2. データ取得の強化 (`src/data_fetcher.py`)

現在の `ticker.info` 取得に加え、テクニカル指標計算用のヒストリカルデータを取得します。

*   **変更点**: `_fetch_single_stock` メソッド内で `stock.history(period="6mo")` を呼び出す。
*   **追加メソッド**: `_calc_technical_indicators(hist)`
    *   **MACD**: 12日/26日EMAの差分と9日シグナルを計算。
    *   **RSI**: 14日間の価格変動から計算。
    *   **結果**: データ辞書に `macd_hist`, `rsi_14`, `trend_signal` などを追加。

### 3. コンテキスト自動同期 (`src/config_loader.py`)

外部ファイル `market_context.txt` からマクロ環境設定を動的に読み込みます。

*   **機能**: `load_config` 時に `market_context.txt` をパース。
*   **タグ形式**:
    *   `[MACRO_SENTIMENT:BULLISH]` -> `config['scoring_v2']['macro']['sentiment'] = 'bullish'`
    *   `[ACTIVE_SECTOR:Tech]` -> `config['scoring_v2']['macro']['active_sector'] = 'Tech'`

### 4. 計算ロジックの刷新 (`src/calc.py`)

`Calculator` クラスを大幅に拡張し、v3.3 のスコアリングロジックを実装します。

*   **メソッド追加**: `calc_v2_score(row, style='value_balanced')`
*   **ロジック詳細**:
    1.  **Fund Score (基礎点)**: PER, PBR, ROE, 配当など (0-100点)
    2.  **Tech Score (テクニカル点)**: MACD, RSI, トレンド定義 (0-100点)
    3.  **統合スコア**: スタイルの重みに基づき加重平均。
        *   `Final = Fund * W_fund + Tech * W_tech`
    4.  **Gap分析**:
        *   `Score_Long`: 長期視点 (Fund重視) でのスコア
        *   `Score_Short`: 短期視点 (Tech重視) でのスコア
        *   `Score_Gap`: `Score_Short - Score_Long` (短期過熱感や割安感の指標)
    5.  **マクロ/セクター補正**:
        *   指定された `active_sector` に合致する場合、ボーナス点を加算。

### 5. 実行引数の拡張 (`stock_analyzer.py`)

CLI引数で分析スタイルを指定可能にします。

*   **引数追加**: `--style` (デフォルト: `value_balanced`)
    *   選択肢: `value_balanced`, `short_term_momentum`, `long_term_growth`
*   **フロー変更**: `main` 関数で引数を受け取り、`StockAnalyzer` -> `Calculator` へ伝播させる。

### 6. 出力とAI連携 (`src/result_writer.py`, `src/ai_agent.py`)

*   **DB/CSV出力**:
    *   カラム追加: `score_long`, `score_short`, `score_gap`, `active_style`
*   **AIプロンプト (`AIAgent`)**:
    *   Gap情報を注入し、AIに「短期的には過熱気味だが長期的には有望」といった文脈のある分析を行わせるプロンプトを生成。

## 移行ステップ

1.  `config.yaml` の更新 (v3.3定義の追加)
2.  `src/data_fetcher.py` の改修 (ヒストリカルデータ取得)
3.  `src/calc.py` のリファクタリング (v2スコア実装)
4.  `stock_analyzer.py` の引数対応
5.  `src/database.py` のスキーマ更新 (マイグレーション)
6.  `src/result_writer.py` の出力形式更新

## 期待される効果

*   **短期/長期の使い分け**: ユーザーの投資戦略に合わせた柔軟なリストアップが可能になる。
*   **分析の質の向上**: 単なる数値の羅列ではなく、マクロ環境を加味した「生きた」スコアリングが実現する。
