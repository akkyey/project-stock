# 2026-01-08 修正履歴

## モジュール安定化リファクタリング

### Phase 1: 優先度「高」モジュール

#### orchestrator.py のリファクタリング
- **変更内容**: Strategy パターンを適用
  - `src/orchestration/` パッケージを新規作成
  - `OrchestratorContext`: 共有リソースを管理するコンテキストクラス
  - `ModeHandler`: モードハンドラの抽象基底クラス
  - `DailyHandler`: Daily ルーチンハンドラ
  - `WeeklyHandler`: Weekly ルーチンハンドラ
  - `MonthlyHandler`: Monthly ルーチンハンドラ
  - `report_helper.py`: レポート出力の共通ロジック
- **効果**: 669行 → 136行に大幅削減、保守性向上

#### database.py のリファクタリング
- **変更内容**: Repository パターンを適用
  - `src/repositories/` パッケージを新規作成
  - `StockRepository`: 銘柄マスタ操作
  - `MarketDataRepository`: 市況データ操作
  - `AnalysisRepository`: 分析結果操作
- **効果**: 404行 → 230行に削減、テスタビリティ向上

### Phase 2: 優先度「中」モジュール

#### ai/agent.py への tenacity 導入
- **変更内容**: リトライ処理の標準化
  - `tenacity` ライブラリによる宣言的リトライ
  - カスタム例外 `RateLimitError`, `TransientAPIError` 導入
  - 指数バックオフ戦略を適用

#### circuit_breaker.py の pybreaker 移行
- **変更内容**: 3状態モデルの実装
  - `pybreaker` ライブラリによる CLOSED/OPEN/HALF_OPEN 状態管理
  - `APICircuitBreaker`: 新しいサーキットブレーカークラス
  - 後方互換性のための `CircuitBreaker` ラッパー

#### sentinel.py のルールエンジン化
- **変更内容**: 検知ルールの分離
  - `src/sentinel/rules/` パッケージを新規作成
  - `DetectionRule`: ルールの抽象基底クラス
  - `VolatilityRule`: 価格急変動検知
  - `TechnicalSignalRule`: テクニカルシグナル検知
  - `RankFluctuationRule`: ランク変動検知
- **効果**: ルールの追加/削除が容易に

### Phase 3: 優先度「低」モジュール

#### config_schema.py の pydantic-settings 対応
- **変更内容**: 設定スキーマの更新
  - `CircuitBreakerConfig` に `reset_timeout` フィールド追加
  - `model_config` で未知フィールドを無視する設定

#### provider.py の cachetools 導入
- **変更内容**: 2層キャッシュ構造
  - `cachetools.TTLCache` によるメモリキャッシュ
  - DB キャッシュとの組み合わせによる高速化
  - `clear_cache()` メソッド追加

### 新規ライブラリ

以下のライブラリを `requirements.txt` に追加:
- `tenacity>=8.0.0`
- `pybreaker>=1.0.0`
- `pydantic-settings>=2.0.0`
- `cachetools>=5.0.0`

### テスト更新

新アーキテクチャに対応するため、以下のテストファイルを更新:
- `tests/unit/test_orchestrator_mock.py`
- `tests/unit/test_orchestrator_coverage.py`
- `tests/unit/test_sentinel_mock.py`
- `tests/unit/test_sentinel_coverage.py`
- `tests/unit/test_database_mock.py`
- `tests/unit/test_provider_mock.py`

### 検証結果

- **全ユニットテスト**: 178 passed
- **静的解析 (ruff)**: 21件自動修正、エラーなし

### Phase 6: カバレッジ改善 (Coverage Improvement)
- **変更内容**: `populated_test_db` Fixture を導入し、DB依存モジュールのテストを強化
  - `src/config_loader.py`: テスト拡充 (14% -> 96%)
  - `src/commands/reset.py`: テスト拡充 (16% -> 86%)
  - `src/sentinel/rules/rank_rule.py`: `RankChangeRule` を `RankFluctuationRule` に名称変更しテスト拡充 (28% -> 86%)
  - `src/orchestration/weekly_handler.py`: テスト拡充 (14% -> 69%)
- **効果**: プロジェクト全体のコードカバレッジが 80% に到達

