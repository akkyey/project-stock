# 2026-01-07 修正履歴

## 実ボラティリティ計算機能の追加
- **対象**: `stock-analyzer4` (Submodule)
- **目的**: 従来のベータ値（beta）が市場との相関のみを示すのに対し、銘柄自身の価格変動の激しさを年率換算で定量化するため。また、ベータ値の欠損を補い全銘柄でのリスク評価を可能にするため。
- **変更内容**:
    1. `src/fetcher/technical.py`: 日次ログリターンの標準偏差から年率ボラティリティを計算するロジックを追加。
    2. `src/fetcher/yahoo.py`: 取得データに `real_volatility` フィールドを追加。
- **検証結果**: 
    - 単体テスト (`tests/unit/test_technical_calculation.py`) パス。
    - ソフトバンクG (9984) にて `real_volatility: 70.60%` の取得を確認（ベータ 0.697 に対し、自身のリスクをより正確に反映）。
- **不具合対応通番**: なし（機能追加）
 
## リスク調整ロジック（ボラティリティ・ペナルティ）の実装
- **対象**: `stock-analyzer4` (Submodule)
- **目的**: 実ボラティリティが高い銘柄（投機的または不安定な銘柄）に対して自動的にスコアを減点し、投資精度の向上を図るため。
- **変更内容**:
    1. `config/config.yaml`: ペナルティ閾値（50%超）と減点幅（-10点）を設定。
    2. `src/calc/strategies/generic.py`: スコア計算ロジック（ベクトル演算・スカラー演算）にボラティリティ・ペナルティ適用処理を追加。
- **検証結果**: 
    - 単体テスト (`tests/unit/test_risk_adjustment.py`) パス。
    - ボラティリティが高いSBG（約70%）に対して、期待通り10点のペナルティが計上されることを確認。
- **不具合対応通番**: なし（機能追加）
 
## AI分析プロンプトへの実リスク（実ボラティリティ）の統合
- **対象**: `stock-analyzer4` (Submodule)
- **目的**: AIが銘柄独自の乱高下リスクを具体的に把握し、より精緻な投資判断・論評を生成できるようにするため。
- **変更内容**:
    1. `src/ai/prompt_builder.py`: `real_volatility` をプロンプト変数に追加。
    2. `config/ai_prompts.yaml`: 
        - 指標セクションに「実ボラティリティ」を追加。
        - 判定基準（判定ロジック）に「実ボラティリティ > 50% の場合は Neutral (Caution) を優先」する指示を追加。
- **検証結果**: 
    - 実際に出力されるプロンプト内容を検証し、具体的な数値（例：70.60%）とリスク警告が正しくAIに提示されていることを確認。
- **不具合対応通番**: なし（機能追加）

## 総合テスト (System Integration Test) とドキュメントへの反映
- **対象**: `stock-analyzer4` (Submodule) および公式ドキュメント (`docs/`)
- **目的**: 
    - システム全体の整合性を検証し、エンドツーエンドでの動作（ロード〜スコア〜AI分析〜レポート）を保証するため。
    - 実装された最新の仕様を設計書およびマニュアルに反映し、ドキュメントの鮮度を維持するため。
- **変更内容**:
    1. **DB/Model 更新**: `MarketData` モデルに `real_volatility` カラムを追加し、DB スキーマを同期（マイグレーション）。
    2. **Reporter 更新**: 各種レポートに `Real_Vol` 項目を追加。
    3. **設計書更新**: `docs/architecture_ja.md`, `docs/manual_ja.md` を v14.0 に更新し、実ボラティリティ関連の記述を追加。
    4. **自己診断更新**: `self_diagnostic.py` でサブモジュールの単体テストも実行するように拡張。
- **検証結果**: 
    - `orchestrator.py weekly` による本番相当の全工程がエラーなく完了。
    - 生成された詳細レポートにおいて、ペナルティ (-10pt) と `real_volatility` の数値が正しく記録されていることを確認。
    - 実 Gemini API による分析結果において、高ボラティリティ銘柄（9984等）が正しくリスク指摘されることを確認。
- **不具合対応通番**: なし（機能追加と品質保証）
## カバレッジ増強 (Phase 6 Coverage Boost)
- **対象**: `stock-analyzer4` (Submodule)
- **目的**: 80%未満のモジュール (`provider.py`, `database.py`, `orchestrator.py`) および `validation_engine.py` の品質保証。
- **変更内容**:
    1. `tests/unit/test_provider_mock.py`: データ取得クエリのMockテスト追加 (22% -> 87%)。
    2. `tests/unit/test_database_mock.py`: DB操作のMockテスト追加 (55% -> 80%)。
    3. `tests/unit/test_orchestrator_mock.py`: DB整合性チェック・リカバリーフローのテスト追加 (55% -> 80%)。
    4. `tests/test_validation_engine_boost.py`: 検証エンジンのロジック網羅テスト追加。
    5. 不要モジュール (`analyzer.py`) の完全削除。
- **検証結果**: 
    - 全体カバレッジ 87% を達成。目標値 (80%+) をクリア。

## 総合テスト・運用テスト (Phase 7 & 8)
- **対象**: プロジェクト全体
- **目的**: 変更後のシステム安定性確認。
- **実施内容**:
    1. **Self Diagnostic**: 41件のサブモジュールテスト完遂。
    2. **Full Suite**: 262件のルート・レガシーテスト完遂。
    3. **Operational Check**: `orchestrator.py daily/weekly` のドライランおよびレポート生成確認。
- **検証結果**: 
    - Regressions (退行) 0件を確認。
    - 生成レポートに新規指標 (Real_Vol) と新AI判定 (Bearish 等) が反映されていることを確認。
