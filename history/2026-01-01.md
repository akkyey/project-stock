# 2026-01-01 修正履歴

## 実施内容: リファクタリング Phase 1-2 (最適化と統合)

#- **2026-01-01 (追加分)**
    - [x] ScoringEngine の単体テスト強化と `_max` フィルター不具合の修正。
    - [x] ValidationEngine の単体テスト強化とセクターポリシー不整合の修正。
    - [x] バリデーションの厳格化 (v12.3): ポリシー外の欠損を 1つでも許容しない仕様へ。
    - [x] 高度なテストスイート (`tests/test_*_advanced.py`) の作成。

### 1. バリデーション機能の統合 (Phase 1.1)
- `src/validator.py` (`DataValidator`) を廃止し、機能を `src/validation_engine.py` (`ValidationEngine`) に統合。
- 共通ヘルパー `_is_empty` を `src/utils.py` の `is_empty` として抽出。
- `src/ai_agent.py` の依存先を `ValidationEngine` に切り替え。

### 2. レポート生成機能の整理 (Phase 1.2)
- `src/reporter.py` と `src/result_writer.py` の責務を明確化。
- `test_result_writer.py` の既存のテスト失敗（カラム名不一致）を修正し、4/4パスを確認。

### 3. スコアリングエンジンの統合 (Phase 1.3)
- `src/engine.py` (`AnalysisEngine`) の主要ロジック（`filter_and_rank`）を `src/calc/engine.py` (`ScoringEngine`) に移植。
- `src/engine.py` は後方互換性のための薄いラッパーに変更。

### 修正履歴 (2026-01-01) - 続報

#### Phase 3: AIAgent 分割リファクタリング
巨大な `AIAgent` クラスを専門的なコンポーネントに分割し、`src/ai/` パッケージとして再構成した。

- **src/ai/agent.py**: `AIAgent` メインクラス。KeyManager, Builder, Parser を統合し、分析ワークフローを管理。
- **src/ai/key_manager.py**: APIキーの読み込み、統計管理、ローテーション、健康診断を担当。
- **src/ai/prompt_builder.py**: 複雑なプロンプト変数準備、閾値読み込み、テンプレート管理を分離。
- **src/ai/response_parser.py**: JSONパース、詳細な品質バリデーション（｜区切り、番号ルール等）を分離。
- **src/ai_agent.py**: エントリポイントとしての後方互換性を維持するためのエイリアス化。

**検証結果:**
- `pytest tests/test_ai_agent_coverage.py`: 15/15 passed.
- `self_diagnostic.py`: All green.
- `AIAgent` クラスにラッパーメソッドを用意することで、既存の高度なテスト（プライベートメソッドのパッチ等）を壊さずにリファクタリングを実現した。

### 4. レガシーコードの削除 (Phase 2)
- `src/archive/` および `tests/archive/` ディレクトリを削除。
- `src/validator.py` をアーカイブ化 (`src/archive_validator.py.bak`)。

### 5. リグレッション修正
- リファクタリング後に発生した既存テスト (`tests/test_engine.py`, `tests/test_score_distribution.py`, `tests/test_ai_agent_coverage.py`) の依存関係エラーを修正。
- 最終的に `pytest` (179/179) および `self_diagnostic` (17/17) の全パスを確認。

### 6. スタイル統一と最適化 (Phase 4)
- **コメント・Docstring の日本語化**: 全主要モジュールのコメントを日本語に翻訳し、Google Style の Docstring を導入。
  - 対象: `src/ai/agent.py`, `src/orchestrator.py`, `src/validation_engine.py`, `src/calc/engine.py`, `src/reporter.py`
- **Orchestrator の整理**:
  - `src/orchestrator.py` の巨大なロジックを整理し、サブプロセス実行やレポート引数準備の重複を排除。
  - レポート出力ロジックを `_export_reports` に集約・共通化。
- **ユーティリティの集約**:
  - `safe_float`, `safe_display_value` などの汎用関数を `src/utils.py` に集約し、各モジュールからの重複記述を削除。
- **品質確認**:
  - `self_diagnostic.py` (17/17passed) により、リファクタリング後の機能整合性を完全に保証。

### 7. Mypy 対応と型安全性の向上 (Phase 5)
- **主要モジュールの型修正**:
    - `src/models.py`: スターインポートの廃止と Peewee モデルへの型ヒント追加。
    - `src/sentinel.py`: テクニカル指標抽出とランク変動検知ロジックの型ガード強化。
    - `src/orchestrator.py`: 辞書キーと引数の型不整合修正。
    - `src/validation_engine.py`: 並列処理結果の型明示とセクターポリシーの型安全化。
- **AI パッケージの完全アノテーション**:
    - `src/ai/agent.py`, `src/ai/key_manager.py`, `src/ai/prompt_builder.py`, `src/ai/response_parser.py` に完全な型ヒントを導入。
- **基盤層の改善**:
    - `src/database.py`: `get_market_data_batch` を追加し、データ取得を高速化・型安全化。
    - `src/fetcher/facade.py`: `fetch_data_from_db` を追加し、DB アクセスを抽象化。
    - `src/calc/v1.py`: Mixin クラスの `self` 型ヒントを解決。
- **解析環境の構築**:
    - `.mypy.ini` を導入し、外部ライブラリの型定義不足を制御しつつ、プロジェクト本体の厳密な型チェックを実現。

## 対応した不具合
- No.1: リファクタリング後の循環参照およびインポートエラーの解消
- No.2: `ResultWriter` のカラムリネームに伴うテスト期待値の乖離修正
- No.3: `src/ai/prompt_builder.py` の文法エラー (SyntaxError) の修正
- No.4: `src/orchestrator.py` のリファクタリング過程で発生したロジック欠損の復旧
- No.5: `ScoringEngine` における `_max` フィルターの動作不備 (<= 比較の修正)
- No.6: `src/sentinel.py` における Pandas `get_loc` の戻り値型不整合による実行時エラーの修正

---

## Weekly処理の問題修正（v12.7 Fix）

### 対象不具合

|  No.  | 通番   | 概要                                                           | 原因                                                             |
| :---: | :----- | :------------------------------------------------------------- | :--------------------------------------------------------------- |
|   7   | WK-001 | turnaround_spec戦略でPERが正常な銘柄にも「PER is NaN」と誤表示 | `prompt_builder.py` で無条件に固定メッセージを追加していた       |
|   8   | WK-002 | バリデーションが正しく機能せず欠損銘柄が候補に残る             | `orchestrator.py` で元データをマージせずスコア結果のみ渡していた |
|   9   | WK-003 | ROE欠損銘柄がランキング上位に来やすい                          | `turnaround.py` でROE欠損時にペナルティがなかった                |

### 修正対象ファイル

- `src/ai/prompt_builder.py` (L79-89): PER条件判定を追加
- `src/orchestrator.py` (L308-324): 元MarketDataのマージ処理追加
- `src/calc/strategies/turnaround.py` (複数箇所): ROE欠損ペナルティ追加

### 検証結果

| 検証項目                      | 結果                               |
| :---------------------------- | :--------------------------------- |
| ROE欠損銘柄へのペナルティ適用 | ✅ 10点ペナルティ確認               |
| Top10にROE欠損銘柄なし        | ✅ 全銘柄がROE正常                  |
| PER正常銘柄への誤指示削除     | ✅ SPECIAL ANALYST INSTRUCTIONなし  |
| バリデーションデータ完全性    | ✅ Valid 37 / Invalid 13 (正常動作) |
| NaN PERへの動的プロンプト対応 | ✅ 正常に検知・指示追加を確認       |
| 自己資本比率チェック緩和      | ✅ 週次処理の継続を確認             |
| config.yamlの設定不備修正     | ✅ PER分析の有効化を確認            |
---

## yfinance 仕様変更対応 (v13.0 二段階取得の実装)

### 対象不具合

|  No.  | 通番     | 概要                                          | 原因                                                                          |
| :---: | :------- | :-------------------------------------------- | :---------------------------------------------------------------------------- |
|  10   | DATA-001 | 自己資本比率が 100% 欠損している              | yfinance の仕様変更により `info` から `equityRatio` が削除された              |
|  11   | DATA-002 | 週次処理（4,000件）での財務諸表取得が失敗する | 大量銘柄に対して重い `balance_sheet` を取得しようとして API 制限 (429) に抵触 |

### 修正内容

1.  **階層型データ取得 (Tiered Fetching) の導入**:
    *   **フェーズ1 (高速推定)**: バルク取得（`ingest`）時は `info` の残存項目（D/Eレシオ、BPS、負債額等）から数値を高速に推定し、ランキングに使用。
    *   **フェーズ2 (精密修復)**: 分析対象（上位銘柄）に選出された際、AI分析の直前に財務諸表をピンポイントで取得し、数値を精密な確定値に自動補正。
2.  **src/fetcher/yahoo.py**: 推定ロジックの実装と `deep_repair` フラグによる精密取得制御を追加。
3.  **src/commands/analyze.py**: AI分析直前での「Deep Refresh」インジェクションを実装。
4.  **src/commands/extract.py**: タスク抽出・検証時にも精密修復を適用。

### 検証結果

| 検証項目                  | 結果                                                             |
| :------------------------ | :--------------------------------------------------------------- |
| バルク取得時の速度/耐性   | ✅ 推定値の採用により API 制限（429）を回避し完走                 |
| 精密修復（トヨタ 7203.T） | ✅ 推定 49.1% → 確定 38.38% (BS由来) への補正を確認               |
| AI分析への反映            | ✅ 補正後の確定値がプロンプトとレポートに反映されていることを確認 |
| 自己診断テスト            | ✅ 全 20 テストパス                                               |
