# 2026-01-05 修正履歴

## リポジトリ構成の大規模分離 (親子構成化)

- **内容**: プロジェクト資産を「実行基盤（コア）」と「管理・品質保証（QA/AI）」に分離。
- **構成**:
    - 親リポジトリ (`project-stock2`): `GEMINI.md`, `docs/`, `tests/`, `history/`, `trouble/`, `full_context/`, `self_diagnostic.py`, `tools/`
    - 子リポジトリ (`stock-analyzer4`): `src/`, `config/`, `data/`, 各実行コマンドスクリプト
- **変更詳細**:
    - `project-stock2` を Git リポジトリとして初期化。
    - `stock-analyzer4` を Git Submodule として登録。
    - `ConfigLoader`: 実行カレントディレクトリによらず `config/config.yaml` を見つけられるように探索ロジックを強化。
    - `ValidationEngine`: 設定が一部欠落していてもクラッシュしないようにガードを追加。
    - `self_diagnostic.py`: インポートパスを新構造に合わせて調整。
    - `tests/conftest.py`: `pytest` 実行時に `stock-analyzer4` を `PYTHONPATH` に自動追加。
    - `generate_full_context.py`: スキャン対象パスを調整。
- **目的**: 運用環境のクリーン化、将来的な公開への備え、および AI エージェントによる統制力の向上。

## テスト失敗の解消 (QA フェーズ)

- **対象ファイル**:
    - `stock-analyzer4/src/result_writer.py`
    - `tests/test_commands.py`
    - `tests/test_sentinel_orchestrator_integration.py`
- **修正内容 (不具合 No.1-4)**:
    - `asyncio.to_thread` のモックを非同期関数 (`async def`) に変更し、コマンド内の `await` が正常に機能するように修正。
    - `BaseCommand` のコンストラクタで初期化される `DataProvider` / `StockDatabase` をパッチ対象とし、モックがコマンドインスタンスに正しく注入されるように改善。
    - `ResultWriter` が `config` の出力パス設定を無視してハードコードされていた問題を修正。
    - インテグレーションテストでの `timedelta` インポート漏れおよびテスト用 DB パス設定の不整合を解消。
- **対応不具合**: No.1, No.2, No.3, No.4
- **結果**: 13件のコマンド・統合テストすべてがパスすることを確認。
